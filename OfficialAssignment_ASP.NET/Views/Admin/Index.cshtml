@{
    ViewData["Title"] = "Trang quản trị";
    Layout = "~/Views/Shared/_Layout.cshtml"; // Reuse main layout for now
}

<div class="container mt-5 mb-5">
    <h2 class="fw-bold mb-4">Tổng quan hệ thống</h2>
    
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100 border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="card-title opacity-75">Doanh thu</h6>
                    <h3 class="fw-bold">@Convert.ToDecimal(ViewBag.TotalRevenue).ToString("N0")₫</h3>
                    <i class="fa-solid fa-sack-dollar fa-2x opacity-50 position-absolute end-0 bottom-0 m-3"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100 border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="card-title opacity-75">Đơn hàng</h6>
                    <h3 class="fw-bold">@ViewBag.TotalOrders</h3>
                    <i class="fa-solid fa-cart-shopping fa-2x opacity-50 position-absolute end-0 bottom-0 m-3"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100 border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="card-title opacity-75">Sản phẩm</h6>
                    <h3 class="fw-bold">@ViewBag.TotalProducts</h3>
                    <i class="fa-solid fa-box-open fa-2x opacity-50 position-absolute end-0 bottom-0 m-3"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-dark h-100 border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <h6 class="card-title opacity-75">Thành viên</h6>
                    <h3 class="fw-bold">@ViewBag.TotalUsers</h3>
                    <i class="fa-solid fa-users fa-2x opacity-50 position-absolute end-0 bottom-0 m-3"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="list-group shadow-sm rounded-4 overflow-hidden mb-4">
                <a href="/Admin" class="list-group-item list-group-item-action active py-3 fw-bold">
                    <i class="fa-solid fa-chart-line me-2"></i> Dashboard
                </a>
                <a href="/Admin/Orders" class="list-group-item list-group-item-action py-3">
                    <i class="fa-solid fa-file-invoice-dollar me-2"></i> Quản lý đơn hàng
                </a>
                <a href="/Admin/Products" class="list-group-item list-group-item-action py-3">
                    <i class="fa-solid fa-box me-2"></i> Quản lý sản phẩm
                </a>
                @if (Context.Session.GetInt32("Role") == 0)
                {
                    <a href="/Admin/Users" class="list-group-item list-group-item-action py-3">
                        <i class="fa-solid fa-users me-2"></i> Quản lý thành viên
                    </a>
                }
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4">Doanh thu 7 ngày gần nhất</h5>
                            <canvas id="revenueChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4">Tỷ lệ trạng thái đơn hàng</h5>
                            <div style="height: 300px; display: flex; justify-content: center;">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch('/Admin/GetChartData')
            .then(response => response.json())
            .then(data => {
                // 1. Revenue Chart (Bar Chart as requested)
                const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctxRevenue, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: data.revenueData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // 2. Status Chart (Doughnut)
                const ctxStatus = document.getElementById('statusChart').getContext('2d');
                new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: ['Chờ xử lý', 'Đang giao', 'Đã giao', 'Đã hủy'],
                        datasets: [{
                            data: data.statusData,
                            backgroundColor: [
                                '#ffc107', // Warning
                                '#0dcaf0', // Info
                                '#198754', // Success
                                '#dc3545'  // Danger
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            });
    });
</script>
